# Shared Code Documentation

This document describes the code shared between the client and server.

## Overview

The `shared/` directory contains utilities and type definitions that are used by both the client and server to ensure consistency and eliminate code duplication.

**Location:** [shared/](../../shared/)

## Benefits

1. **Single Source of Truth** - Types and utilities defined once
2. **Type Safety** - TypeScript ensures both client and server use identical types
3. **No Duplication** - Tile rotation logic exists in one place
4. **Consistency** - Game rules and data structures are identical on both sides
5. **Maintainability** - Fix bugs or add features once, applies everywhere

## Directory Structure

```
shared/
├── types/
│   ├── game.ts           # Game-related type definitions
│   └── index.ts          # Type exports
├── utils/
│   └── tileUtils.ts      # Tile manipulation functions
├── package.json          # Package metadata
└── README.md             # Usage guide
```

## Shared Types

**File:** [shared/types/game.ts](../../shared/types/game.ts)

### Core Game Types

All of these types are defined once in the shared directory and imported by both client and server:

#### `PlayerColor`

Player colors available in the game.

```typescript
type PlayerColor = 'red' | 'green' | 'blue' | 'white';
```

**Usage:** Each player in a game must choose one of these four colors. Colors are unique within a game.

#### `GameStage`

Game lifecycle stages.

```typescript
type GameStage = 'unstarted' | 'playing' | 'finished';
```

**Usage:** Tracks the current state of a game.

#### `TurnPhase`

Turn phases during gameplay.

```typescript
type TurnPhase = 'shift' | 'move';
```

**Usage:** Each player's turn consists of two phases:
1. `shift` - Player shifts a row or column on the board
2. `move` - Player moves their piece on the board

#### `Position`

Board position coordinates.

```typescript
type Position = [number, number];  // [row, col]
```

**Usage:** Represents a coordinate on the 7×7 game board as `[row, col]` where row and col are 0-6.

#### `Tile`

Tile representation using bitmask.

```typescript
type Tile = number;  // 0-15, 4-bit bitmask
```

**Usage:** Each tile is a number (0-15) representing a 4-bit bitmask where each bit indicates if a side is open:
- Bit 0 (0x1): Left side open
- Bit 1 (0x2): Right side open
- Bit 2 (0x4): Top side open
- Bit 3 (0x8): Bottom side open

**Examples:**
- Corner tile (Right+Bottom): `0x2 | 0x8 = 0xA` (binary 1010)
- Straight tile (Left+Right): `0x1 | 0x2 = 0x3` (binary 0011)
- T-junction (Left+Right+Bottom): `0x1 | 0x2 | 0x8 = 0xB` (binary 1011)

#### `TokenId`

Token identifier.

```typescript
type TokenId = number;  // 0-20
```

**Usage:** Represents a token ID. The game has 21 tokens (IDs 0-20).

#### `Player`

Player in a game.

```typescript
interface Player {
  username: string;
  color: PlayerColor;
}
```

**Usage:** Represents a player in a game with their chosen color.

#### `CurrentTurn`

Current turn state.

```typescript
interface CurrentTurn {
  username: string;
  color: PlayerColor;
  phase: TurnPhase;
}
```

**Usage:** Represents whose turn it is and what phase they're in. Used by client to display current turn info, generated by server from `currentPlayerIndex` and `currentPhase`.

## Shared Utilities

**File:** [shared/utils/tileUtils.ts](../../shared/utils/tileUtils.ts)

### Tile Bitmask Constants

```typescript
export const LEFT = 0x1;    // Bit 0
export const RIGHT = 0x2;   // Bit 1
export const TOP = 0x4;     // Bit 2
export const BOTTOM = 0x8;  // Bit 3
```

**Usage:** Use these constants to check or set tile sides:
```typescript
const tile: Tile = LEFT | RIGHT;  // Straight tile (horizontal)
const hasLeft = !!(tile & LEFT);  // Check if left side is open
```

### Tile Manipulation Functions

#### `rotateTileClockwise(tile: Tile): Tile`

Rotates a tile 90 degrees clockwise.

**Rotation mapping:**
- LEFT → TOP
- TOP → RIGHT
- RIGHT → BOTTOM
- BOTTOM → LEFT

**Example:**
```typescript
const tile = createTile('RB');  // 0xA (Right+Bottom)
const rotated = rotateTileClockwise(tile);  // 0x9 (Left+Bottom)
```

#### `rotateTileCounterClockwise(tile: Tile): Tile`

Rotates a tile 90 degrees counter-clockwise.

**Rotation mapping:**
- LEFT → BOTTOM
- BOTTOM → RIGHT
- RIGHT → TOP
- TOP → LEFT

**Example:**
```typescript
const tile = createTile('RB');  // 0xA (Right+Bottom)
const rotated = rotateTileCounterClockwise(tile);  // 0x6 (Right+Top)
```

#### `rotateTileNTimes(tile: Tile, n: number): Tile`

Rotates a tile N times (0-3) clockwise.

**Parameters:**
- `tile` - The tile to rotate
- `n` - Number of 90-degree clockwise rotations (automatically takes modulo 4)

**Example:**
```typescript
const tile = createTile('RB');  // 0xA (Right+Bottom)
const rotated = rotateTileNTimes(tile, 2);  // 0x5 (Left+Top) - 180 degrees
```

#### `createTile(sides: string): Tile`

Creates a tile from string notation.

**Parameters:**
- `sides` - String containing any combination of: 'L' (Left), 'R' (Right), 'T' (Top), 'B' (Bottom)
- Case insensitive

**Examples:**
```typescript
createTile('RB');    // 0xA - Corner tile
createTile('LR');    // 0x3 - Straight tile (horizontal)
createTile('LRB');   // 0xB - T-junction
createTile('LRTB');  // 0xF - All sides open (cross)
```

#### `getTileSides(tile: Tile): string`

Gets the string representation of a tile for debugging.

**Returns:** String with sides in alphabetical order (BLRT)

**Examples:**
```typescript
getTileSides(0xA);   // 'BR'
getTileSides(0x3);   // 'LR'
getTileSides(0xB);   // 'BLR'
getTileSides(0xF);   // 'BLRT'
```

## How to Import

### Client (React/Vite)

```typescript
// Import types
import type { PlayerColor, Player, Position, Tile } from '@shared/types';

// Import utilities
import { rotateTileClockwise, LEFT, RIGHT, TOP, BOTTOM } from '@shared/utils/tileUtils';
```

### Server (Node/Express)

```typescript
// Import types
import type { PlayerColor, Player, Position, Tile } from '@shared/types';

// Import utilities
import { rotateTileClockwise, createTile, getTileSides } from '@shared/utils/tileUtils';
```

## Configuration

### Client Setup

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@shared/*": ["../shared/*"]
    }
  },
  "include": ["src", "../shared"]
}
```

**vite.config.ts:**
```javascript
import path from 'path';

export default defineConfig({
  resolve: {
    alias: {
      '@shared': path.resolve(__dirname, '../shared')
    }
  }
});
```

### Server Setup

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@shared/*": ["../shared/*"]
    }
  },
  "include": ["src/**/*", "../shared/**/*"]
}
```

## What's Shared vs. What's Not

### Shared (in this directory)

✅ **Game domain types** - PlayerColor, GameStage, TurnPhase, Position, Tile, TokenId, Player, CurrentTurn
✅ **Tile manipulation utilities** - Rotation, creation, validation
✅ **Tile bitmask constants** - LEFT, RIGHT, TOP, BOTTOM

### Client-Specific

- Form data types (CreateGameFormData, JoinGameFormData, etc.)
- Client User interface (includes JWT token)
- Client Game interface (uses CurrentTurn instead of currentPlayerIndex)

### Server-Specific

- Server User interface (includes passwordHash, salt, createdAt)
- Server Game interface (uses currentPlayerIndex/currentPhase)
- API Request/Response types

## Related Documentation

- [Server Models](../server/models.md) - Server-side data structures
- [Client Types](../client/types.md) - Client-side type definitions
- [API Endpoints](../server/api-endpoints.md) - REST API reference
